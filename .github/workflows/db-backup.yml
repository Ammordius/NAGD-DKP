# Supabase (public schema) backup only when data has changed; tiered artifacts.
# Uses same secrets as loot-to-character: SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY (REST API export, no pg_dump).
# When backing up: uploads rolling (~last 3), weekly (first of week), monthly (first of month).
# See docs/CI-DB-BACKUP.md for size estimate and restore steps.

name: DB backup (on change)

on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

concurrency:
  group: db-backup
  cancel-in-progress: false

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Check if backup needed (data changed)
        id: check
        run: |
          CURRENT=""
          if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            CURRENT=$(python fetch_raid_loot_from_supabase.py --count-only 2>/dev/null || echo "")
          fi
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          LAST=""
          if [ -f .ci/last_backup_trigger_count.txt ]; then
            LAST=$(cat .ci/last_backup_trigger_count.txt)
          fi
          if [ -n "$CURRENT" ] && [ "$CURRENT" = "$LAST" ]; then
            echo "backup_needed=false" >> $GITHUB_OUTPUT
            echo "No change (raid_loot count $CURRENT), skipping backup."
          else
            echo "backup_needed=true" >> $GITHUB_OUTPUT
            echo "Backup needed (current=$CURRENT, last=$LAST)."
          fi

      - name: Export public tables and compress
        id: export
        if: steps.check.outputs.backup_needed == 'true'
        run: |
          DATE=$(date -u +%Y-%m-%d)
          ISO_WEEK=$(date -u +%G-W%V)
          MONTH=$(date -u +%Y-%m)
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "iso_week=$ISO_WEEK" >> $GITHUB_OUTPUT
          echo "month=$MONTH" >> $GITHUB_OUTPUT
          python export_supabase_public_tables.py --out-dir backup
          tar czf "backup-$DATE.tar.gz" backup
          echo "size_bytes=$(stat -c%s backup-$DATE.tar.gz)" >> $GITHUB_OUTPUT
          echo "Backup size: $(($(stat -c%s backup-$DATE.tar.gz) / 1024)) KB"

      - name: Upload rolling backup (~last 3)
        if: steps.export.outputs.date != ''
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-${{ steps.export.outputs.date }}
          path: backup-${{ steps.export.outputs.date }}.tar.gz
          retention-days: 7

      - name: Upload weekly backup (first of week)
        id: weekly
        if: steps.export.outputs.date != ''
        run: |
          LAST_WEEK=""
          [ -f .ci/last_weekly_backup_week.txt ] && LAST_WEEK=$(cat .ci/last_weekly_backup_week.txt)
          UPLOAD="false"
          [ "${{ steps.export.outputs.iso_week }}" != "$LAST_WEEK" ] && UPLOAD="true"
          echo "upload_weekly=$UPLOAD" >> $GITHUB_OUTPUT

      - name: Upload weekly artifact
        if: steps.export.outputs.date != '' && steps.weekly.outputs.upload_weekly == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-weekly-${{ steps.export.outputs.iso_week }}
          path: backup-${{ steps.export.outputs.date }}.tar.gz
          retention-days: 90

      - name: Upload monthly backup (first of month)
        id: monthly
        if: steps.export.outputs.date != ''
        run: |
          LAST_MONTH=""
          [ -f .ci/last_monthly_backup_month.txt ] && LAST_MONTH=$(cat .ci/last_monthly_backup_month.txt)
          UPLOAD="false"
          [ "${{ steps.export.outputs.month }}" != "$LAST_MONTH" ] && UPLOAD="true"
          echo "upload_monthly=$UPLOAD" >> $GITHUB_OUTPUT

      - name: Upload monthly artifact
        if: steps.export.outputs.date != '' && steps.monthly.outputs.upload_monthly == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-monthly-${{ steps.export.outputs.month }}
          path: backup-${{ steps.export.outputs.date }}.tar.gz
          retention-days: 90

      - name: Record backup and push
        if: steps.export.outputs.date != ''
        run: |
          mkdir -p .ci
          echo "${{ steps.check.outputs.current }}" > .ci/last_backup_trigger_count.txt
          echo "${{ steps.export.outputs.iso_week }}" > .ci/last_weekly_backup_week.txt
          echo "${{ steps.export.outputs.month }}" > .ci/last_monthly_backup_month.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .ci/last_backup_trigger_count.txt .ci/last_weekly_backup_week.txt .ci/last_monthly_backup_month.txt
          git diff --staged --quiet || (git commit -m "chore: update backup trigger and weekly/monthly markers" && git push)

      - name: Skip (no change)
        if: steps.check.outputs.backup_needed == 'false'
        run: echo "No data change; backup skipped."