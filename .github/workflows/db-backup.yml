# Supabase (public schema) backup only when data has changed; tiered artifacts.
# Runs on schedule and checks raid_loot count; if unchanged, skips backup (~3 raids/week so most days skip).
# When backing up: uploads rolling (~last 3), weekly (first backup of week), monthly (first backup of month).
# See docs/CI-DB-BACKUP.md for size estimate and restore steps.
#
# Secrets: SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY (for change check), SUPABASE_DATABASE_URL (for pg_dump).
# If SUPABASE_DATABASE_URL is unset, backup is skipped. workflow_dispatch always runs the change check but can force backup.

name: DB backup (on change)

on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

concurrency:
  group: db-backup
  cancel-in-progress: false

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Check if backup needed (data changed)
        id: check
        run: |
          CURRENT=""
          if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            CURRENT=$(python fetch_raid_loot_from_supabase.py --count-only 2>/dev/null || echo "")
          fi
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          LAST=""
          if [ -f .ci/last_backup_trigger_count.txt ]; then
            LAST=$(cat .ci/last_backup_trigger_count.txt)
          fi
          if [ -n "$CURRENT" ] && [ "$CURRENT" = "$LAST" ]; then
            echo "backup_needed=false" >> $GITHUB_OUTPUT
            echo "No change (raid_loot count $CURRENT), skipping backup."
          else
            echo "backup_needed=true" >> $GITHUB_OUTPUT
            echo "Backup needed (current=$CURRENT, last=$LAST)."
          fi

      - name: Install PostgreSQL client
        if: steps.check.outputs.backup_needed == 'true' && env.SUPABASE_DATABASE_URL != ''
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Dump public schema and compress
        id: dump
        if: steps.check.outputs.backup_needed == 'true' && env.SUPABASE_DATABASE_URL != ''
        run: |
          DATE=$(date -u +%Y-%m-%d)
          ISO_WEEK=$(date -u +%G-W%V)
          MONTH=$(date -u +%Y-%m)
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "iso_week=$ISO_WEEK" >> $GITHUB_OUTPUT
          echo "month=$MONTH" >> $GITHUB_OUTPUT
          URI="$SUPABASE_DATABASE_URL"
          if [[ "$URI" != *"sslmode="* ]]; then
            if [[ "$URI" == *"?"* ]]; then URI="${URI}&sslmode=require"; else URI="${URI}?sslmode=require"; fi
          fi
          pg_dump "$URI" -n public --no-owner --no-acl -f "backup-$DATE.sql" || { echo "::error::pg_dump failed"; exit 1; }
          gzip -f "backup-$DATE.sql"
          echo "size_bytes=$(stat -c%s backup-$DATE.sql.gz)" >> $GITHUB_OUTPUT
          echo "Backup size: $(($(stat -c%s backup-$DATE.sql.gz) / 1024)) KB"

      - name: Upload rolling backup (~last 3)
        if: steps.dump.outputs.date != ''
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-${{ steps.dump.outputs.date }}
          path: backup-${{ steps.dump.outputs.date }}.sql.gz
          retention-days: 7

      - name: Upload weekly backup (first of week)
        id: weekly
        if: steps.dump.outputs.date != ''
        run: |
          LAST_WEEK=""
          [ -f .ci/last_weekly_backup_week.txt ] && LAST_WEEK=$(cat .ci/last_weekly_backup_week.txt)
          UPLOAD="false"
          [ "${{ steps.dump.outputs.iso_week }}" != "$LAST_WEEK" ] && UPLOAD="true"
          echo "upload_weekly=$UPLOAD" >> $GITHUB_OUTPUT

      - name: Upload weekly artifact
        if: steps.dump.outputs.date != '' && steps.weekly.outputs.upload_weekly == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-weekly-${{ steps.dump.outputs.iso_week }}
          path: backup-${{ steps.dump.outputs.date }}.sql.gz
          retention-days: 90

      - name: Upload monthly backup (first of month)
        id: monthly
        if: steps.dump.outputs.date != ''
        run: |
          LAST_MONTH=""
          [ -f .ci/last_monthly_backup_month.txt ] && LAST_MONTH=$(cat .ci/last_monthly_backup_month.txt)
          UPLOAD="false"
          [ "${{ steps.dump.outputs.month }}" != "$LAST_MONTH" ] && UPLOAD="true"
          echo "upload_monthly=$UPLOAD" >> $GITHUB_OUTPUT

      - name: Upload monthly artifact
        if: steps.dump.outputs.date != '' && steps.monthly.outputs.upload_monthly == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup-monthly-${{ steps.dump.outputs.month }}
          path: backup-${{ steps.dump.outputs.date }}.sql.gz
          retention-days: 90

      - name: Record backup and push
        if: steps.dump.outputs.date != ''
        run: |
          mkdir -p .ci
          echo "${{ steps.check.outputs.current }}" > .ci/last_backup_trigger_count.txt
          echo "${{ steps.dump.outputs.iso_week }}" > .ci/last_weekly_backup_week.txt
          echo "${{ steps.dump.outputs.month }}" > .ci/last_monthly_backup_month.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .ci/last_backup_trigger_count.txt .ci/last_weekly_backup_week.txt .ci/last_monthly_backup_month.txt
          git diff --staged --quiet || (git commit -m "chore: update backup trigger and weekly/monthly markers" && git push)

      - name: Skip (no change or no DB URL)
        if: steps.check.outputs.backup_needed == 'false' || env.SUPABASE_DATABASE_URL == ''
        run: |
          if [ -z "$SUPABASE_DATABASE_URL" ]; then
            echo "SUPABASE_DATABASE_URL not set; skipping (see docs/CI-DB-BACKUP.md)."
          else
            echo "No data change; backup skipped."
          fi