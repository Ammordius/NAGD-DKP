# Restore Supabase from a GitHub backup artifact (e.g. after a bad migration).
# Manual run only. Uses SUPABASE_URL + SUPABASE_SERVICE_ROLE_KEY (same as DB backup).
# See docs/CI-DB-BACKUP.md and docs/CI-DB-RESTORE.md.

name: DB restore from backup

on:
  workflow_dispatch:
    inputs:
      artifact_name:
        description: "Use 'latest' for most recent backup, or paste a name from the list shown in the first step (e.g. supabase-backup-2026-02-20)"
        required: true
        default: latest
      load_only:
        description: "Truncate already run in Supabase (load only; much faster). Run docs/supabase-restore-truncate.sql in SQL Editor first."
        required: false
        type: boolean
        default: false

concurrency:
  group: db-restore
  cancel-in-progress: false

jobs:
  restore:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read   # list backup artifacts
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Supabase secrets
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "::error::Set SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY in Settings → Secrets and variables → Actions (same as DB backup workflow). See docs/CI-DB-RESTORE.md"
            exit 1
          fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: List backup artifacts
        id: list
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "## Available backup artifacts (DB backup workflow)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # Backup workflow only uploads when data changed; find most recent run that has an artifact
          RUN_IDS=$(gh api "repos/${{ github.repository }}/actions/workflows/db-backup.yml/runs?per_page=20&status=completed" --jq '.workflow_runs[].id')
          LATEST=""
          for RUN_ID in $RUN_IDS; do
            ARTIFACTS=$(gh api "repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts" --jq '[.artifacts[] | select(.name | startswith("supabase-backup")) | .name]')
            NAMES=$(echo "$ARTIFACTS" | jq -r '.[]')
            if [ -n "$NAMES" ]; then
              for N in $NAMES; do
                echo "- **$N**" >> $GITHUB_STEP_SUMMARY
                if [ -z "$LATEST" ]; then LATEST="$N"; fi
              done
              break
            fi
          done
          if [ -z "$LATEST" ]; then
            echo "No backup artifacts found. Run **DB backup (on change)** when data has changed (it only uploads when raid_loot count changes)." >> $GITHUB_STEP_SUMMARY
            echo "latest_name=" >> $GITHUB_OUTPUT
          else
            echo "latest_name=$LATEST" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Using **$LATEST** when artifact_name is 'latest'." >> $GITHUB_STEP_SUMMARY
          fi
          echo "Artifacts listed above. Copy a name to restore from that backup, or use 'latest' for the most recent."

      - name: Resolve artifact name
        id: resolve
        run: |
          if [ "${{ inputs.artifact_name }}" = "latest" ]; then
            NAME="${{ steps.list.outputs.latest_name }}"
            if [ -z "$NAME" ]; then
              echo "::error::No backup artifacts found. Run 'DB backup (on change)' first or choose an existing artifact."
              exit 1
            fi
            echo "resolved_name=$NAME" >> $GITHUB_OUTPUT
            echo "Restoring from latest: $NAME"
          else
            echo "resolved_name=${{ inputs.artifact_name }}" >> $GITHUB_OUTPUT
            echo "Restoring from: ${{ inputs.artifact_name }}"
          fi

      - name: Download backup artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: db-backup.yml
          name: ${{ steps.resolve.outputs.resolved_name }}
          path: restore-artifact
          if_no_artifact_found: fail

      - name: Extract backup
        run: |
          cd restore-artifact
          tar xzf backup-*.tar.gz
          ls -la backup/
          mv backup ..
          cd ..
          ls -la backup/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Restore database
        run: python scripts/restore_supabase_from_backup.py --backup-dir backup ${{ inputs.load_only && '--load-only' || '' }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Restore summary
        if: success()
        run: |
          echo "Restore completed."
          echo "- Run refresh_dkp_summary() and refresh_all_raid_attendance_totals() in Supabase SQL Editor if needed."
          echo "- To repopulate loot assignments (assigned_char_id / assigned_character_name), run **Actions → Loot-to-character assignment** (Run workflow). See docs/CI-DB-RESTORE.md."
