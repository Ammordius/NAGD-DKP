# Loot-to-character assignment: link raid_loot to the toon that actually has each item.
# We need the Magelo dump (character + inventory from TAKP) to know which character has which
# item; the script matches account loot rows to toons using that inventory. Fully separate
# from the Magelo repo's CI. Runs at most once per day, or when raid/loot data changes, or manually.
#
# To push assignments to Supabase (no duplicates), set repo secrets:
#   SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY
# Then CI will: check if raid_loot count changed -> if so, fetch -> assign -> update Supabase by id.
# The live DB is the source of truth; we do not commit the CSVs. Run at most once daily (cron) or manually.
# We only pull Magelo and run assignment when there is new loot (count changed); otherwise skip.

name: Loot-to-character assignment

on:
  schedule:
    # Once daily at 18:00 UTC (after TAKP Magelo export is typically updated)
    - cron: '0 18 * * *'
  workflow_dispatch:

concurrency:
  group: loot-to-character
  cancel-in-progress: false

jobs:
  assign:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - name: Checkout DKP repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      # When Supabase secrets set: skip Magelo pull and assignment unless raid_loot count changed.
      - name: Check for new loot
        id: check
        if: ${{ env.SUPABASE_URL != '' && env.SUPABASE_SERVICE_ROLE_KEY != '' }}
        run: |
          CURRENT=$(python fetch_raid_loot_from_supabase.py --count-only)
          LAST=""
          if [ -f .ci/last_raid_loot_count.txt ]; then
            LAST=$(cat .ci/last_raid_loot_count.txt)
          fi
          if [ "$CURRENT" = "$LAST" ] && [ -n "$CURRENT" ]; then
            echo "new_loot=false" >> $GITHUB_OUTPUT
            echo "No new loot (count $CURRENT unchanged), skipping Magelo pull and assignment."
          else
            echo "new_loot=true" >> $GITHUB_OUTPUT
            echo "Loot count changed or first run (current=$CURRENT, last=$LAST), will run assignment."
          fi

      - name: Fetch raid_loot from Supabase
        if: ${{ env.SUPABASE_URL != '' && env.SUPABASE_SERVICE_ROLE_KEY != '' && steps.check.outputs.new_loot == 'true' }}
        run: python fetch_raid_loot_from_supabase.py --out data/raid_loot.csv

      - name: Download Magelo dumps from TAKP
        if: ${{ env.SUPABASE_URL != '' && env.SUPABASE_SERVICE_ROLE_KEY != '' && steps.check.outputs.new_loot == 'true' }}
        run: |
          mkdir -p .magelo_dump
          echo "Downloading character dump (names, char_ids)..."
          curl -sfL -o .magelo_dump/TAKP_character.txt \
            "https://www.takproject.net/magelo/export/TAKP_character.txt" || {
            echo "::error::Failed to download TAKP_character.txt"
            exit 1
          }
          echo "Downloading inventory dump (which char_id has which item)..."
          curl -sfL -o .magelo_dump/TAKP_character_inventory.txt \
            "https://www.takproject.net/magelo/export/TAKP_character_inventory.txt" || {
            echo "::error::Failed to download TAKP_character_inventory.txt"
            exit 1
          }
          echo "Character lines: $(wc -l < .magelo_dump/TAKP_character.txt)"
          echo "Inventory lines: $(wc -l < .magelo_dump/TAKP_character_inventory.txt)"

      - name: Run loot-to-character assignment
        if: ${{ env.SUPABASE_URL != '' && env.SUPABASE_SERVICE_ROLE_KEY != '' && steps.check.outputs.new_loot == 'true' }}
        run: |
          python assign_loot_to_characters.py \
            --character-file .magelo_dump/TAKP_character.txt \
            --inventory-file .magelo_dump/TAKP_character_inventory.txt \
            --elemental-armor-json data/elemental_armor.json \
            --out-raid-loot data/raid_loot.csv \
            --out-counts data/character_loot_assignment_counts.csv

      - name: Push assignments to Supabase (update by id, no duplicates)
        if: ${{ env.SUPABASE_URL != '' && env.SUPABASE_SERVICE_ROLE_KEY != '' && steps.check.outputs.new_loot == 'true' }}
        run: python update_raid_loot_assignments_supabase.py --csv data/raid_loot.csv

      - name: Record raid_loot count
        if: ${{ env.SUPABASE_URL != '' && env.SUPABASE_SERVICE_ROLE_KEY != '' && steps.check.outputs.new_loot == 'true' }}
        run: |
          mkdir -p .ci
          python fetch_raid_loot_from_supabase.py --count-only > .ci/last_raid_loot_count.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .ci/last_raid_loot_count.txt
          if git diff --staged --quiet; then
            echo "No count file change"
          else
            git commit -m "chore: update last_raid_loot_count for loot-to-character skip check"
            git push
          fi
