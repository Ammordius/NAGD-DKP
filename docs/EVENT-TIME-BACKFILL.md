# Event time (tic time) backfill

Update **raid_events.event_time** in Supabase from scraped data **without truncating or re-importing** raids/events.

## 1. One-time: RPC in Supabase

In **Supabase SQL Editor**, run:

```sql
-- docs/supabase-update-event-times-rpc.sql
```

This creates the `update_raid_event_times(data jsonb)` function used by the CLI.

## 2. Local credentials (optional)

So you can run the update from CLI without exporting env vars each time:

```bash
cp .env.example .env
# Edit .env: SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY from Supabase → Settings → API
```

`.env` is gitignored; do not commit it.

## 3. CSV with event_time

Use **either** source:

- **data/raid_events.csv** — After re-running `extract_structured_data.py` (with the fixed parser) on `raids/*.html`, this file has `event_time` populated. Use it directly.
- **data/raid_events_event_time_backfill.csv** — Generated by `backfill_event_times.py` (or from local HTML if you add that path). Three columns: `raid_id`, `event_id`, `event_time`.

## 4. Run the update

```bash
# From repo root (dkp/)
python update_supabase_event_times.py
```

Defaults: reads `data/raid_events_event_time_backfill.csv`, batch size 500. To use the full raid_events CSV:

```bash
python update_supabase_event_times.py --csv data/raid_events.csv
```

Credentials are read from the environment or from `.env` (if `python-dotenv` is installed). No truncate, no re-import — only `raid_events.event_time` is updated for matching `(raid_id, event_id)`.
